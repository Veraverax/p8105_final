---
title: "Word Cloud"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r message = FALSE}
library(tidyverse)
library(plotly)
library(tidytext)
library(RColorBrewer)
library(tidytext)
library(wordcloud2)
library(knitr)
library(webshot)
library("htmlwidgets")
```


```{r subset, message = FALSE, warning = FALSE}
# Read in tidy wine data and generate subsets for new world, old world, higher-rating (>=90), and lower-rating (<90) wines.
wine_df = read_csv("./wine_data/tidy/wine_all.csv")
red_df =  read_csv("./wine_data/tidy/wine_red.csv")
white_df = read_csv("./wine_data/tidy/wine_white.csv")
rose_df = read_csv("./wine_data/tidy/wine_rose.csv")
sparkling_df = read_csv("./wine_data/tidy/wine_sparkling.csv")

new_red = red_df %>% filter(new_world == TRUE)
old_red = red_df %>% filter(old_world == TRUE)
new_white = white_df %>% filter(new_world == TRUE)
old_white = white_df %>% filter(old_world == TRUE)
new_rose = rose_df %>% filter(new_world == TRUE)
old_rose = rose_df %>% filter(old_world == TRUE)
new_sparkling = sparkling_df %>% filter(new_world == TRUE)
old_sparkling = sparkling_df %>% filter(old_world == TRUE)

high_wine = wine_df %>% filter(points >= 90)
low_wine = wine_df %>% filter(points < 90)
high_red = red_df %>% filter(points >= 90)
low_red = red_df %>% filter(points < 90)
high_white = white_df %>% filter(points >= 90)
low_white = white_df %>% filter(points < 90)
high_rose = rose_df %>% filter(points >= 90)
low_rose = rose_df %>% filter(points < 90)
high_sparkling = sparkling_df %>% filter(points >= 90)
low_sparkling = sparkling_df %>% filter(points < 90)
```

# Top 10 Wine Notes

```{r top10, message = FALSE}
wine_top10_word <- function(wine_subset){
  # reshape the .txt data frame into one column
  wine_word = 
    wine_subset %>% 
    select(description) %>% 
    unnest_tokens(word, description) %>% 
    dplyr::count(word, sort = TRUE) %>% 
    ungroup()
  
  # remove uninformative words
  data("stop_words")
  wine_word = 
    anti_join(wine_word, stop_words)
  
  # remove more uninformative words in our study
  other_meaningless <- data.frame(word = c("style", "character", "vineyard", "wine", "drink", "flavors", "notes", "note", "finish", "structure", "texture", "blend", "mouth", "touch", "feels", "offers", "nose", "age", "palate", "cabernet", "pinot", "noir", "chardonnay", "sauvignon", "riesling", "aromas", "color", "yellow", "green", "black", "red", "white", "rose", "rosé", "sparkling"))
  wine_word = 
    wine_word %>% 
    anti_join(other_meaningless, by = "word")
  
  # remove numbers
  nums = wine_word %>% filter(str_detect(word, "^[0-9]")) %>% select(word) %>% unique()
  wine_word = wine_word %>% 
    anti_join(nums, by = "word")
  
  # check the top 10 words
  wine_word %>% head(10) %>% as_tibble()
}

red_top10 <- wine_top10_word(red_df)[,1] %>% rename(red = word)
white_top10 <- wine_top10_word(white_df)[,1]  %>% rename(white = word)
rose_top10 <- wine_top10_word(rose_df)[,1]  %>% rename(rose = word)
sparkling_top10 <- wine_top10_word(sparkling_df)[,1]  %>% rename(sparkling = word)
as_tibble(c(red_top10, white_top10, rose_top10, sparkling_top10)) %>% 
  mutate(rank = 1:n()) %>% 
  select(rank, red:sparkling) %>% 
  knitr::kable()
```

The top 10 wine notes generated by the keywords from taster's descriptions match with commonly identified tasting notes for each wine type. Red wine has keywords of tannins, cherry, oak and blackberry. White wine has keywords of citrus, lemon and peach. Rose and sparkling both have keywords of crisp, fresh, fruit(y), and dry. The keywords that appear in the top 10 for all four wine types are fruit(y) and acidity.

# Word Cloud
```{r wordcloud, message = FALSE}
# Create word cloud for each type (red, white, rose, and sparkling)
wine_word_cloud <- function(wine_subset, color1, color2) {
  # reshape the .txt data frame into one column
  wine_word = 
    wine_subset %>% 
    select(description) %>% 
    unnest_tokens(word, description) %>% 
    dplyr::count(word, sort = TRUE) %>% 
    ungroup()
  
  # remove uninformative words
  data("stop_words")
  wine_word = 
    anti_join(wine_word, stop_words)
  
  # remove more uninformative words in our study
  other_meaningless <- data.frame(word = c("style", "character", "vineyard", "wine", "drink", "flavors", "notes", "note", "finish", "structure", "texture", "blend", "mouth", "touch", "feels", "offers", "nose", "age",  "palate", "cabernet", "pinot", "noir", "chardonnay", "sauvignon", "riesling", "aromas", "color", "yellow", "green", "black", "red", "white", "rose", "rosé", "sparkling"))
  wine_word = 
    wine_word %>% 
    anti_join(other_meaningless, by = "word")
  
  # remove numbers
  nums = wine_word %>% filter(str_detect(word, "^[0-9]")) %>% select(word) %>% unique()
  wine_word = wine_word %>% 
    anti_join(nums, by = "word")
  
  # plot word cloud
  wine_word %>% head(100) %>% 
    wordcloud2(size = 0.58, color = color1, backgroundColor = color2)
}
```

Word cloud presents the key tasting notes by showing frequent words in larger font sizes. In this section, we first take a close look at keywords for all wines and compare higher-rated vs. lower-rated wines.

***Put the cursor onto each word to see their frequencies!***

<br>

## All types
```{r message = FALSE}
all_wine_word <- wine_word_cloud(wine_df, "red", "white")
all_wine_word
```

### (1) Higher-rated (>=90)
```{r message = FALSE}
higer_wine_word <- wine_word_cloud(high_wine, "blue", "white")
higer_wine_word
```

### (2) Lower-rated (<90)
```{r message = FALSE}
lower_wine_word <- wine_word_cloud(low_wine, "green", "white")
lower_wine_word
```

In overall, higher-rated wines share many key words with lower-rated wines. [Regression analysis](regression.html) would take a deeper look by comparing at their differences among specific wine type groups.

<br>
***Then, we generate word cloud for each wine type.***

## Red wine
```{r message = FALSE}
red_word <- wine_word_cloud(red_df, "8D021F", "white")
red_word
```

### (1) New-world red wine
```{r message = FALSE}
new_red_word <- wine_word_cloud(new_red, "#A1045A", "white")
new_red_word
```

### (2) Old-world red wine
```{r message = FALSE}
old_red_word <- wine_word_cloud(old_red, "#67032F", "white")
old_red_word
```

As introduced in our "About the data" [page](data_intro.html), wines are categorized by new and old world. From word clouds above, "tannins" appears more frequently in the descriptions for old-world red wines, while "blackberry" appears more frequently in the descriptions for new-world red wines.

<br>
***Next, let's take a look a white wine's.***

## White wine
```{r message = FALSE}
white_word <- wine_word_cloud(white_df, "FEDC56", "white")
white_word
```

### (1) New-world white wine
```{r message = FALSE}
new_white_word <- wine_word_cloud(new_white, "#F9E076", "white")
new_white_word
```

### (2) Old-world white wine
```{r message = FALSE}
old_white_word <- wine_word_cloud(old_white, "D2B55B", "white")
old_white_word
```

Both new-world and old-world white wines have many fruity notes. "Acidity" appears more frequently in the descriptions for old-world white wines, but other than that, there is no obvious difference between the two.

<br>
***Lastly, we have word clouds for rose and sparkling.*** 

## Rose
```{r message = FALSE}
rose_word <- wine_word_cloud(rose_df, "E75480", "white")
rose_word
```

## Sparkling
```{r, fig.align="center", message = FALSE}
sparkling_word <- wine_word_cloud(sparkling_df, "F5B799", "white")
sparkling_word
```

Both rose and sparkling would have many good wines for beginners, given the tasting notes of crisp and fresh. New and old world comparisons are not made here as this categorization is usually not used for these two types.

```{r export, include = FALSE}
#Export word cloud as .png as preparation for report
export_word <- function(word_cloud, html_file, output, file_delete){
  saveWidget(word_cloud, html_file, selfcontained = F)
  webshot(html_file, output, delay = 5, vwidth = 500, vheight = 500)
  file.remove(html_file)
  unlink(file_delete, recursive = TRUE)
}

export_word(all_wine_word, "tmp1.html", "./image/all_wine_word.png", "tmp1_files")
export_word(higer_wine_word, "tmp2.html", "./image/higer_wine_word.png", "tmp2_files")
export_word(lower_wine_word, "tmp3.html", "./image/lower_wine_word.png", "tmp3_files")
export_word(red_word, "tmp4.html", "./image/red_word.png", "tmp4_files")
export_word(new_red_word, "tmp5.html", "./image/new_red_word.png", "tmp5_files")
export_word(old_red_word, "tmp6.html", "./image/old_red_word.png", "tmp6_files")
export_word(white_word, "tmp7.html", "./image/white_word.png", "tmp7_files")
export_word(new_white_word, "tmp8.html", "./image/new_white_word.png", "tmp8_files")
export_word(old_white_word, "tmp9.html", "./image/old_white_word.png", "tmp9_files")
export_word(rose_word, "tmp10.html", "./image/rose_word.png", "tmp10_files")
export_word(sparkling_word, "tmp11.html", "./image/sparkling_word.png", "tmp11_files")
```


