---
title: "Maps"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true

---

```{r setup, include=FALSE}
library(tidyverse)
library(leaflet)
library(ggplot2)
library(tigris)
library(plotly)
library(rgdal)
library(maps)
library(mapproj)
library(RColorBrewer)
```

```{r tidying_data, message=FALSE, warning = FALSE}
wine_tidy_df = 
  read_csv(
  "./wine_data/tidy/wine_all.csv") %>% 
  janitor::clean_names()
```

```{r wine_us, warning = FALSE}
wine_us = wine_tidy_df %>% 
  filter(country == "US") %>%
  rename(
    state = province) %>% 
  mutate(
   state = na_if(state, "America")
 ) %>%
  select(state, points, price) %>% 
  drop_na() %>% 
  group_by(state) %>%
  summarise(
    total = n(),
    avg_rating = mean(points),
    avg_price = mean(price)
  ) %>%
  mutate(
    avg_rating = round(avg_rating, 0), 
    avg_price = round(avg_price, 2)
    ) %>% 
  arrange(desc(total))
```

```{r missing_us}
wine_us_missing = wine_tidy_df %>% 
  filter(country == "US") %>%
  rename(
    state = province) %>% 
  select(state, points, price) %>% 
  mutate(
   state = na_if(state, "America")
 )

purrr::map(wine_us_missing, ~ sum(is.na(.)))
```

### US Mapping Explanations:
Missing Values:

* State: 95
* Points: 0
* Price: 239

Several wines that were made in the US did not have a province/state listed. Instead they were labeled as America. Recoded America into NA. many wines also did not have prices listed. Wines that did not have points, prices, or province were excluded from the final mapping dataset...

Rounded rating to nearest whole number and price to 2 decimal places.

```{r country_df, warning = FALSE}
wine_by_country = wine_tidy_df %>% 
 mutate(
   country = recode(country, US = "United States")
 ) %>% 
  select(country, points, price) %>% 
  group_by(country) %>%
  drop_na() %>% 
  summarise(
    total = n(),
    avg_rating = mean(points),
    avg_price = mean(price)
  ) %>%
  mutate(
    avg_rating = round(avg_rating, 0), 
    avg_price = round(avg_price, 2)
    ) %>% 
  arrange(desc(total))
```

```{r country_missing}
wine_country_missing = wine_tidy_df %>% 
 mutate(
   country = recode(country, US = "United States")
 ) %>% 
  select(country, points, price)

purrr::map(wine_country_missing, ~ sum(is.na(.)))
```

### World Mapping Explanations:
Missing Values:

* Country: 63
* Points: 0
* Price: 8996

Several wines did not contain country of origin or price. Wines that did not have country or prices were excluded from the final world mapping dataset...

```{r choropleth_map, echo = T, warning = F, results = 'hide'}
states <- states(cb = TRUE)

states %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(popup = ~NAME)

states_merged_wine <- geo_join(states, wine_us, "NAME", "state")

mybins <- c(0,100,1000,8000,10000,40000)
mypal <- colorBin(palette = "Purples", domain = states_merged_wine$total, na.color = "transparent", bins = mybins)

states_merged_wine <- subset(states_merged_wine, !is.na(total))

popup <- paste0(
  states_merged_wine$NAME,"<br>", 
  "Total Wines: ", states_merged_wine$total, "<br>", 
      "Avg Rating: ", states_merged_wine$avg_rating, "<br>",
      "Avg Price: $", states_merged_wine$avg_price,"<br>"
      )

state_map = states_merged_wine %>% 
  leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  setView(-98.483330, 38.712046, zoom = 4) %>% 
  addPolygons(
    fillColor = ~mypal(total), 
    fillOpacity = 1.0, 
    weight = 0.4, 
    smoothFactor = 0.2, 
    popup = ~popup) %>% 
  addLegend(pal = mypal, 
            values = states_merged_wine$total, 
            position = "bottomright", 
            title = "Wines")
```

```{r world_map_labels_choropleth, echo = T, warning = F, results = 'hide'}
world_spdf <- readOGR( 
  dsn = paste0(getwd(),"/wine_data/world_shape_file/") , 
  layer = "TM_WORLD_BORDERS_SIMPL-0.3",
  verbose = FALSE
)

world_spdf %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(popup = ~NAME)

countries_merged_wine <- geo_join(world_spdf, wine_by_country, "NAME", "country")

world_bins <- c(0,100,1000,10000,20000,30000,60000)
world_pal <- colorBin(palette = "RdPu", domain = countries_merged_wine$total, na.color = "transparent", bins = world_bins)

countries_merged_wine <- subset(countries_merged_wine, !is.na(total))

world_popup <- paste0(
  countries_merged_wine$country,"<br>", 
  "Wines: ", countries_merged_wine$total, "<br>", 
      "Avg Rating: ", countries_merged_wine$avg_rating, "<br>",
      "Avg Price: $", countries_merged_wine$avg_price,"<br>"
      )

world_map_labels = countries_merged_wine %>% 
  leaflet() %>%
  addMapPane(name = "polygons", zIndex = 410) %>% 
  addMapPane(name = "maplabels", zIndex = 420) %>% 
  addProviderTiles("CartoDB.PositronNoLabels") %>%
  addProviderTiles("CartoDB.PositronOnlyLabels", 
                   options = leafletOptions(pane = "maplabels"),
                   group = "map labels") %>%
  setView( lat = 10, lng = 0 , zoom = 2) %>% 
  addPolygons(
    fillColor = ~world_pal(total), 
    fillOpacity = 1.0, 
    group = "country",
    weight = 0.4, 
    smoothFactor = 0.2, 
    popup = ~world_popup,
    options = leafletOptions(pane = "polygons")) %>%
  addLayersControl(overlayGroups = c("map labels",
                                     "country")) %>% 
  addLegend(pal = world_pal, 
            values = countries_merged_wine$total, 
            position = "bottomright", 
            title = "Wines")
```

## Static Map

```{r static_map}
world_static = map_data("world") %>%
  left_join(wine_by_country, by = c("region" = "country"))

ggplot(data = world_static, 
               mapping = aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = avg_rating)) +
  scale_fill_continuous(low = "rosybrown1", high = "darkred", 
                        na.value = "snow2") +
  coord_map(xlim = c(-180,180), ylim = c(-60, 80)) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y  = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_rect(fill = "white"))
```

## Interactive Maps {.tabset}

### United States

```{r state_map}
state_map
```

### World
```{r world_maps}
world_map_labels
```

## {-}

#### Mapping Next Steps

* Take screenshot of maps?

* Update about page and report for mapping

* Review interactive - shiny lecture
