---
title: "Mapping"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(leaflet)
library(ggplot2)
library(tigris)
library(plotly)
library(rgdal)
```

Read in wine data.

```{r extract_year_function}
year_extract <- function(string) {
  t <- regmatches(string, regexec("[1-2][9|0][0-9][0-9]", string))
  sapply(t, function(x) {
    if (length(x) > 0) {
      return(as.numeric(x))
    } else {
      return(NA)    
    }
  })
}
```

```{r tidying_data, message=FALSE}
wine_tidy_df = 
  read_csv(
  "./wine_data/winemag-data-130k-v2.csv") %>% 
  janitor::clean_names() %>% 
  select(-region_2, -taster_twitter_handle, -taster_name, -x1) %>% 
  mutate(year = year_extract(title))
```

```{r wine_us}
wine_us = wine_tidy_df %>% 
  filter(country == "US") %>%
  rename(
    state = province) %>% 
  mutate(
   state = na_if(state, "America")
 ) %>%
  select(state, points, price) %>% 
  drop_na() %>% 
  group_by(state) %>%
  summarise(
    total = n(),
    avg_rating = mean(points),
    avg_price = mean(price)
  ) %>%
  mutate(
    avg_rating = round(avg_rating, 0), 
    avg_price = round(avg_price, 2)
    ) %>% 
  arrange(desc(total))
```

```{r missing_us}
wine_us_missing = wine_tidy_df %>% 
  filter(country == "US") %>%
  rename(
    state = province) %>% 
  select(state, points, price) %>% 
  mutate(
   state = na_if(state, "America")
 )

map(wine_us_missing, ~ sum(is.na(.)))
```

### US Mapping Explanations:
Missing Values:

* State: 95
* Points: 0
* Price: 239

Several wines that were made in the US did not have a province/state listed. Instead they were labeled as America. Recoded America into NA. many wines also did not have prices listed. Wines that did not have points, prices, or province were excluded from the final mapping dataset...

Rounded rating to nearest whole number and price to 2 decimal places.

```{r country_df}
wine_by_country = wine_tidy_df %>% 
 mutate(
   country = recode(country, US = "United States")
 ) %>% 
  select(country, points, price) %>% 
  group_by(country) %>%
  drop_na() %>% 
  summarise(
    total = n(),
    avg_rating = mean(points),
    avg_price = mean(price)
  ) %>%
  mutate(
    avg_rating = round(avg_rating, 0), 
    avg_price = round(avg_price, 2)
    ) %>% 
  arrange(desc(total))
```

```{r country_missing}
wine_country_missing = wine_tidy_df %>% 
 mutate(
   country = recode(country, US = "United States")
 ) %>% 
  select(country, points, price)

map(wine_country_missing, ~ sum(is.na(.)))
```

### World Mapping Explanations:
Missing Values:

* Country: 63
* Points: 0
* Price: 8996

Several wines did not contain country of origin or price. Wines that did not have country or prices were excluded from the final world mapping dataset...

```{r choropleth_map, echo = T, warning = F, results = 'hide'}
states <- states(cb = TRUE)

states %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(popup = ~NAME)

states_merged_wine <- geo_join(states, wine_us, "NAME", "state")

mybins <- c(0,100,1000,8000,10000,40000)
mypal <- colorBin(palette = "Purples", domain = states_merged_wine$total, na.color = "transparent", bins = mybins)

states_merged_wine <- subset(states_merged_wine, !is.na(total))

popup <- paste0(
  states_merged_wine$NAME,"<br>", 
  "Wineries: ", states_merged_wine$total, "<br>", 
      "Avg Rating: ", states_merged_wine$avg_rating, "<br>",
      "Avg Price: ", states_merged_wine$avg_price,"<br>"
      )

state_map = states_merged_wine %>% 
  leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  setView(-98.483330, 38.712046, zoom = 4) %>% 
  addPolygons(
    fillColor = ~mypal(total), 
    fillOpacity = 1.0, 
    weight = 0.4, 
    smoothFactor = 0.2, 
    popup = ~popup) %>% 
  addLegend(pal = mypal, 
            values = states_merged_wine$total, 
            position = "bottomright", 
            title = "Wineries")
```

```{r state_map}
state_map
```


```{r world_choropleth, echo = T, warning = F, results = 'hide'}
world_spdf <- readOGR( 
  dsn = paste0(getwd(),"/wine_data/world_shape_file/") , 
  layer = "TM_WORLD_BORDERS_SIMPL-0.3",
  verbose = FALSE
)

world_spdf %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(popup = ~NAME)

countries_merged_wine <- geo_join(world_spdf, wine_by_country, "NAME", "country")

world_bins <- c(0,100,1000,10000,20000,30000,60000)
world_pal <- colorBin(palette = "Reds", domain = countries_merged_wine$total, na.color = "transparent", bins = world_bins)

countries_merged_wine <- subset(countries_merged_wine, !is.na(total))

world_popup <- paste0(
  countries_merged_wine$country,"<br>", 
  "Wineries: ", countries_merged_wine$total, "<br>", 
      "Avg Rating: ", countries_merged_wine$avg_rating, "<br>",
      "Avg Price: ", countries_merged_wine$avg_price,"<br>"
      )

world_map_nolab = countries_merged_wine %>% 
  leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  setView( lat = 10, lng = 0 , zoom = 2) %>% 
  addPolygons(
    fillColor = ~world_pal(total), 
    fillOpacity = 1.0, 
    weight = 0.4, 
    smoothFactor = 0.2, 
    popup = ~world_popup) %>% 
  addLegend(pal = world_pal, 
            values = countries_merged_wine$total, 
            position = "bottomright", 
            title = "Wineries")
```

```{r world_map_labels, echo = T, warning = F, results = 'hide'}
world_map_labels = countries_merged_wine %>% 
  leaflet() %>%
  addMapPane(name = "polygons", zIndex = 410) %>% 
  addMapPane(name = "maplabels", zIndex = 420) %>% 
  addProviderTiles("CartoDB.PositronNoLabels") %>%
  addProviderTiles("CartoDB.PositronOnlyLabels", 
                   options = leafletOptions(pane = "maplabels"),
                   group = "map labels") %>%
  setView( lat = 10, lng = 0 , zoom = 2) %>% 
  addPolygons(
    fillColor = ~world_pal(total), 
    fillOpacity = 1.0, 
    group = "country",
    weight = 0.4, 
    smoothFactor = 0.2, 
    popup = ~world_popup,
    options = leafletOptions(pane = "polygons")) %>%
  addLayersControl(baseGroups = "CartoDB.PositronNoLabels",
                   overlayGroups = c("map labels",
                                     "country"))
```

```{r world_maps}
world_map_nolab

world_map_labels
```


#### Mapping Thoughts/Questions

* Is legend necessary?

* For world map, aesthetics....overlay is a lil funky looking
Adding labels may help...
(not sure how to deal with the overlap button tho...)

Potential Ideas: 

* https://rstudio.github.io/leaflet/showhide.html

BaseMap, dark or light?

Base Map options:
http://leaflet-extras.github.io/leaflet-providers/preview/

Code adapted from https://www.r-graph-gallery.com/183-choropleth-map-with-leaflet.html