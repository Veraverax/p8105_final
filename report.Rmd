---
title: "Report"
output: 
  html_document:
    code_folding: hide
---

```{r}
library(tidyverse)
library(leaflet)
library(ggplot2)
library(plotly)
library(readxl)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r}
wine_df = 
  read_csv(
  "./wine_data/tidy/wine_all.csv")

### remove region 2, taster twitter and missing values in region 1.

#wine_type <- read_csv("./wine_data/winemag-data-130k-v2.csv") %>% 
#            group_by(variety) %>% 
#            count() %>% 
#            arrange(desc(n)) %>% 
#            as.tibble()

```

Your report should include the following topics. Depending on your project type the amount of discussion you devote to each of them will vary:

# Motivation:

This dataset offers us a great opportunity to explore what factors are associated with wine ratings. We hope to conduct regression analysis of the wine rating and price based on location/grape type/notes/region and see if there are significant difference among these categorical predictors. The regression model would help customers estimate and predict wine rating with a series of wine characteristics. We also want to provide people with a interactive website to visualize wine ratings and prices.

# Related work: 

Anything that inspired you, such as a paper, a web site, or something we discussed in class.


# Initial questions: 

We are trying to answer some questions from exploratory analysis. 
To understand the information that customers could get from the ratings, price among different wine type and region, we want to answer the following questions:

1. What is the distribution of prices among four types of wine? Is at least one wine type's price different from the others?

2. What is the distribution of ratings among four types of wine? Is at least one wine type's rating different from the others?

3. What is the average price of wines at different regions? Which region has the highest average price wine?

4. What is the average rating of wines at different regions? Which region has the highest average rating?

5. What is the trend of price over time among 4 types of wine? 

6. What is the trend of ratings over time among 4 types of wine?

7. What is the average ratings by each tasters? Who rates the highest price wine? Who reviews the largest number of wines?

8. Which winery has the top average ratings wine? 

9. Is there any differences in prices between new world and old world wine?

10. Is there any differences in ratings between new world and old world wine?



1. Wine distribution worldwide: 

- correspond to the world map
- correspond to the word cloud


3. Linear model - predict
Based on the information we have about a bottle of wine, how can we predict the price and points?

What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis?

4. Didn't address yet - interactive plot (shiny)
- filter by price
- filter by country
- filter by wine type

# Data: 
Source, scraping method, cleaning, etc.

The data for this project is downloaded from [Kaggle](https://www.kaggle.com/zynicide/wine-reviews). It was scraped on November 22nd, 2017 from the [WineEnthusiast Rating database](https://www.winemag.com/?s=&drink_type=wine). Wine Enthusiast is a magazine provide information on wine quality, wine variety, tours and eventsâ€”in short - everything about wine. 

This dataset contains `r nrow(wine_df)` wine reviews with variety, location, winery, price, description and reviewer information. There is much information on description and title on each wine. We had extracted from the text of useful information such as the year the wine was made in and the characteristics of the taste. 

### *Variables of interest*

```{r}
## Vera in charge of editing this sector
```

##### **Outcomes**

  * `price` . Count of evictions (or eviction filings) per year at the census tract level.
  * `rating`. Calculated using number of evictions or eviction filings divided by the number of `renter_occupied_households` and multiplied by 100, to be interpreted as a percentage. 

##### **Candidate Predictors**

  * `years_since_2010`. Since our data range from 2010 to 2016, and we did not want to assume a constant effect of time, we included year as a set of indicator variables in all models except our empty model (see below).
  * `hisp`. Percent of population (at census tract level, for all race/ethnicity variables) that self-report Hispanic ethnicity.
  * `white`. Percent self-reporting White race.
  * `black`. Percent self-reporting Black race.
  * `asian`. Percent self-reporting Asian race.
  * `aian`. Percent self-reporting American Indian / Alaska Native race.
  * `nhpi`. Percent self-reporting Native Hawaiian / Pacific Islander race.
  * `other`. Percent self-reporting other race.
  * `rent_burden`. Average percent of income spent on rent.
  * `density`. Population density.
  * `pct_eng`. Percent of population who speak English less than 'Very Well'. This is interpreted as a proxy for percent English as a second language (ESL) speakers. 
  * `median_household_income`. Median census tract household income in USD.
  * `poverty_rate`. Percent living below Federal Poverty Line (FPL).
  * `median_gross_rent`. Median census tract gross rent in USD.
  * `pct_renter_occupied`. Percent of census tract occupied by renters.
  * `median_property_value`. Median census tract property value in USD.
  * `family_size`. Average family size in census tract.
  * `pct_fam_households`. Percentage of census tract households that contain families.





At first, the dataset contains more than 50 wine varieties and it is hard to get useful information. Therefore, we had categorized all varieties to four types of wine: red, white, rose and sparkling according to the following infographics on [Wine Folly](https://winefolly.com/deep-dive/different-types-of-wine/).

# Exploratory analysis: 

<br><br>

## Descriptive Statistics

### Distribution of price/rating by wine type
Question: What is the distribution of prices/rating among four types of wine? Is at least one wine type's price/rating different from the others?

To explore this question, we first look at the wine with price lower than $100 since there are many very expensive wine and it is hard to show the distribution with a very long tail. We want to graph a boxplot of prices for each of the four types of wine: red, rose, sparkling and white. It is interesting to see that red and sparking wine have similar distribution with mean price around $27. The prices of rose are lower than the other three types and are mostly round $10~$20. In addition, we run an ANOVA test to find if at least one of the wine types'e price is different from the others. 

We repeat the same process to ratings. The results for price and ratings are both significant. Therefore, we can conclude that there is at least one wine type's price/rating significantly different from the others. 

This inform further modeling to see if we can based on the type of wine to predict its price and rating.

```{r, message=FALSE, warning=FALSE}
wine_df %>% 
  filter(!is.na(type),
         price <= 100) %>% 
  ggplot(aes(x = type, y = price, color = type)) +
  geom_boxplot()

wine_price = 
  wine_df %>% 
  filter(price <= 100)
res.aov <- aov(price ~ type, data = wine_price)
summary(res.aov)


wine_df %>% 
  filter(!is.na(type)) %>% 
  rename(rating = points) %>% 
  ggplot(aes(x = type, y = rating, color = type)) +
  geom_boxplot()

res.aov <- aov(points ~ type, data = wine_df)
summary(res.aov)

```

<br><br>


### Distribution of price/rating by region
Question: What is the average price/rating of wines at different regions? Which region has the highest average price/rating wine? 

To answer this question, we look at the average price grouped by the country they come from. We have created an interactive plot to show the rank of price and ratings. Switzerland has the highest mean price of wine at $85. England is the second highest and Germany is the third. 
England has the highest average rating. Indis and Austria are the second and third highest.
Even though Switzerland has the highest priced wine, the average ratings is only ranked at 11. Wine in Switzerland is not very recommended. 

This inform further modeling to see if we can based on the origin of the wine to predict its price and rating.


```{r, message=FALSE, warning=FALSE}
y <- list(
  title = "Mean Price"
)
wine_df %>% 
  filter(!is.na(price)) %>% 
  group_by(country) %>% 
  summarise(mean = mean(price)) %>% 
  mutate(country = fct_reorder(country, mean),
         mean = round(mean, 2),
        text_label=str_c("Country:", country, "\nmean price:", mean)) %>% 
  plot_ly(
  x = ~country, y = ~mean, color = ~country, text = ~text_label, 
  type = "bar", colors = "viridis") %>% 
  layout(yaxis = y)
  
y <- list(
  title = "Mean rating"
)
wine_df %>% 
  filter(!is.na(points)) %>% 
  group_by(country) %>% 
  summarise(mean = mean(points)) %>% 
  mutate(country = fct_reorder(country, mean),
         avg_rating = round(mean, 2),
        text_label=str_c("Country:", country, "\nmean rating:", mean)) %>% 
  plot_ly(
  x = ~country, y = ~avg_rating, color = ~country, text = ~text_label, 
  type = "bar", colors = "viridis") %>% 
  layout(yaxis = list(range = c(80,95)))

```


<br><br>


### Trend of price/rating over time
Question: What is the trend of price/rating over time among 4 types of wine? 

For this question, we first start with extracting the year from the description on the wine bottle. We use a regex function to pull out the year the wine is made in. However, some of the year did not make sense so we choose to filter out all the wine before 2000 from our data. Then, we made a line plot to show the trend of price and rating over time. 

For prices, we can see a trend that wines that are older are more expensive. Among the wine that were produced before 2010, Sparkling wine have the highest prices among all types but the prices decreases with the year closer to present. Among the wine that were produced after 2010, red wines are the most expensive. 2002 is a good year for sparling wine and 2004 is a good year for white wine

For ratings, we can see a trend that sparkling wines that are older have higher ratings. For other types of wine, the ratings are stable. Therefore, the age of the wine does not affect the rating much for red, rose and white wines. Among the wine that were produced before 2010, Sparkling wine have the highest ratings among all types but the ratings decreases with the year closer to present.

We could add year as a predictor in our future modeling. 

```{r, message=FALSE, warning=FALSE}
wine_df %>% 
  filter(!is.na(price),
         !is.na(type),
         year > 2000) %>% 
  group_by(year,type) %>% 
  summarise(mean = mean(price)) %>% 
  mutate(mean = round(mean, 2)) %>% 
  ggplot(aes(x = year, y = mean, color = type))+
  geom_point()+
  geom_line() +
  labs(y = "Mean price",
      x = "Year")
wine_df %>% 
  filter(!is.na(points),
         !is.na(type),
         year > 2000) %>% 
  group_by(year,type) %>% 
  summarise(mean = mean(points)) %>% 
  mutate(mean = round(mean, 2)) %>% 
  ggplot(aes(x = year, y = mean, color = type))+
  geom_point()+
  geom_line() +
  labs(y = "Mean rating",
      x = "Year")

```

<br><br>


### Price and ratings by taster.
Question: Who rates the highest price wine? Who reviews the largest number of wines?

We also have data on who rated the wine and want to extract some information from it. We ploted an interactive bar plot to show the avergae ratings for each taster.
```{r, message=FALSE, warning=FALSE}
y <- list(
  title = "Mean ratings"
)

  wine_df %>% 
  filter(!is.na(points)) %>% 
  group_by(taster_name) %>% 
  summarise(mean = mean(points)) %>% 
  mutate(taster_name = fct_reorder(taster_name, mean),
         mean = round(mean, 2),
        text_label=str_c("Taster:", taster_name, "\nmean rating:", mean)) %>% 
  plot_ly(
  x = ~taster_name, y = ~mean, color = ~taster_name, text = ~text_label, 
  type = "bar", colors = "viridis") %>% 
 layout(yaxis = list(range = c(80,95)))

```

We also want to know the tasters that rated wines with price greater than $800 and most of the most expensive wine are rated by Roger Voss.

```{r, message=FALSE, warning=FALSE}

wine_df %>% 
  filter(price >= 800,
         !is.na(taster_name)) %>% 
  group_by(taster_name) %>% 
  summarise(number_of_wine = n()) %>% 
  arrange(desc(number_of_wine)) %>% 
  knitr::kable()

```

In addition, we find out that Roger Voss rated the most number of wine at WineEthusiast Magazine. 
```{r, message=FALSE, warning=FALSE}
wine_df %>% 
  filter(!is.na(taster_name)) %>% 
  group_by(taster_name) %>% 
  summarise(number_of_wine = n()) %>% 
  arrange(desc(number_of_wine)) %>% 
  knitr::kable()

```


<br><br>


### Winery and ratings
Question: Which winery has the top average ratings wine? 

We want to know that if the origin of a wine affect the ratings. We group by winery and country and get the avergae points of the wines at each winery. We ranked them in descending order and picked out the top 10. Araujo in the US has the highest average rating of 98. Among the top 10 wineries, four of them are in the US and four of them are in the France.

This could be a useful information if we want to predict whether a wine will be rated high or not based on the winery it came from.

```{r, message=FALSE, warning=FALSE}

wine_df %>% 
  filter(!is.na(winery)) %>% 
  group_by(winery,country) %>% 
  summarise(mean = mean(points)) %>% 
  arrange(desc(mean)) %>% 
  head(n = 10) %>% 
  knitr::kable()


```

<br><br>


### Differences of prices/ratings between new world and old world wine

We followed a popular categorizing method to divided all the wines to new world and old world. We wanted to investigate that whether this categorization will affect the price or rating for a wine. We created boxplot to show the distribution of prices and ratings for two groups: new world and old world. In addition, we conducted a two sample t-test to see there is a significant differences in prices or ratings between the two groups. 

In conclusion, we found out that ratings for new world or old world wine are not different from the others but prices of new world or old world wine are significantly different from the others.

This could also be useful information in our regression analysis.

```{r, message=FALSE, warning=FALSE}
wine_df %>% 
  mutate(new_old = ifelse(new_world == 0, "old_world", "new_world")) %>% 
  rename(rating = points) %>% 
  ggplot(aes(x = new_old, y = rating, color =new_old)) +
  geom_boxplot() +
    labs(y = "Mean rating",
      x = "new vs old world wine")
wine_new_old=
wine_df %>% 
  mutate(new_old = ifelse(new_world == 0, "old_world", "new_world"))
t.test(price ~ new_old, data = wine_new_old)

wine_df %>% 
  mutate(new_old = ifelse(new_world == 0, "old_world", "new_world")) %>% 
  filter(price <= 100) %>% 
  ggplot(aes(x = new_old, y = price, color =new_old)) +
  geom_boxplot() +
    labs(y = "Mean price",
      x = "new vs old world wine")

wine_price = 
wine_df %>% 
  mutate(new_old = ifelse(new_world == 0, "old_world", "new_world")) %>% 
  filter(price<=100)
t.test(price ~ new_old, data = wine_price)



```

<br><br>


### Visualizations
In order to make the US map and World map, we created two separate datasets. The US dataset contained only wines that were from the US. 

```{r tidying_data, message = FALSE, warning = FALSE}
wine_tidy_df = 
  read_csv(
  "./wine_data/tidy/wine_all.csv") %>% 
  janitor::clean_names()
```

```{r wine_us, message = FALSE}
wine_us = wine_tidy_df %>% 
  filter(country == "US") %>%
  rename(
    state = province) %>% 
  mutate(
   state = na_if(state, "America")
 ) %>%
  select(state, points, price) %>% 
  drop_na() %>% 
  group_by(state) %>%
  summarise(
    total = n(),
    avg_rating = mean(points),
    avg_price = mean(price)
  ) %>%
  mutate(
    avg_rating = round(avg_rating, 0), 
    avg_price = round(avg_price, 2)
    ) %>% 
  arrange(desc(total))
```

```{r missing_us, results = 'hide'}
wine_us_missing = wine_tidy_df %>% 
  filter(country == "US") %>%
  rename(
    state = province) %>% 
  select(state, points, price) %>% 
  mutate(
   state = na_if(state, "America")
 )

purrr::map(wine_us_missing, ~ sum(is.na(.)))
```

```{r country_df, message = FALSE}
wine_by_country = wine_tidy_df %>% 
 mutate(
   country = recode(country, US = "United States")
 ) %>% 
  select(country, points, price) %>% 
  group_by(country) %>%
  drop_na() %>% 
  summarise(
    total = n(),
    avg_rating = mean(points),
    avg_price = mean(price)
  ) %>%
  mutate(
    avg_rating = round(avg_rating, 0), 
    avg_price = round(avg_price, 2)
    ) %>% 
  arrange(desc(total))
```

```{r country_missing, results = 'hide'}
wine_country_missing = wine_tidy_df %>% 
 mutate(
   country = recode(country, US = "United States")
 ) %>% 
  select(country, points, price)

purrr::map(wine_country_missing, ~ sum(is.na(.)))
```

Wines that contained missing prices and state or country information were removed from the dataset. Among all wines made in the US, there were several wines that were labeled as America under state. Those wines were recoded as missing state values and removed from the US dataset. From the US dataset, there were 95 wines that did not have a state value and 239 wines that were missing a price. From the world dataset, there were 63 wines that missing country information and 8996 wines that did not have a price listed. All wines in the dataset had a rating. As the number of missing values was relatively small in comparison to the total number of observations, all wines that contained missing information on wine origin and price were excluded from the map. 

For each dataset, we used `summarise` to generate average ratings and average prices for each state or country, along with the total count of all wines from each state or country. Average ratings was rounded to the nearest whole number and prices were rounded to 2 decimal points.

```{r choropleth_map, eval=F, echo=T}
states <- states(cb = TRUE)

states %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(popup = ~NAME)

states_merged_wine <- geo_join(states, wine_us, "NAME", "state")

mybins <- c(0,100,1000,8000,10000,40000)
mypal <- colorBin(palette = "Purples", domain = states_merged_wine$total, na.color = "transparent", bins = mybins)

states_merged_wine <- subset(states_merged_wine, !is.na(total))

popup <- paste0(
  states_merged_wine$NAME,"<br>", 
  "Total Wines: ", states_merged_wine$total, "<br>", 
      "Avg Rating: ", states_merged_wine$avg_rating, "<br>",
      "Avg Price: $", states_merged_wine$avg_price,"<br>"
      )

state_map = states_merged_wine %>% 
  leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  setView(-98.483330, 38.712046, zoom = 4) %>% 
  addPolygons(
    fillColor = ~mypal(total), 
    fillOpacity = 1.0, 
    weight = 0.4, 
    smoothFactor = 0.2, 
    popup = ~popup) %>% 
  addLegend(pal = mypal, 
            values = states_merged_wine$total, 
            position = "bottomright", 
            title = "Wines")
```

```{r world_map_labels_choropleth, eval=F,  echo=T}
world_spdf <- readOGR( 
  dsn = paste0(getwd(),"/wine_data/world_shape_file/") , 
  layer = "TM_WORLD_BORDERS_SIMPL-0.3",
  verbose = FALSE
)

world_spdf %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(popup = ~NAME)

countries_merged_wine <- geo_join(world_spdf, wine_by_country, "NAME", "country")

world_bins <- c(0,100,1000,10000,20000,30000,60000)
world_pal <- colorBin(palette = "RdPu", domain = countries_merged_wine$total, na.color = "transparent", bins = world_bins)

countries_merged_wine <- subset(countries_merged_wine, !is.na(total))

world_popup <- paste0(
  countries_merged_wine$country,"<br>", 
  "Wines: ", countries_merged_wine$total, "<br>", 
      "Avg Rating: ", countries_merged_wine$avg_rating, "<br>",
      "Avg Price: $", countries_merged_wine$avg_price,"<br>"
      )

world_map_labels = countries_merged_wine %>% 
  leaflet() %>%
  addMapPane(name = "polygons", zIndex = 410) %>% 
  addMapPane(name = "maplabels", zIndex = 420) %>% 
  addProviderTiles("CartoDB.PositronNoLabels") %>%
  addProviderTiles("CartoDB.PositronOnlyLabels", 
                   options = leafletOptions(pane = "maplabels"),
                   group = "labels") %>%
  setView( lat = 10, lng = 0 , zoom = 2) %>% 
  addPolygons(
    fillColor = ~world_pal(total), 
    fillOpacity = 1.0, 
    group = "country",
    weight = 0.4, 
    smoothFactor = 0.2, 
    popup = ~world_popup,
    options = leafletOptions(pane = "polygons")) %>% 
  addLayersControl(overlayGroups = c("labels")) %>% 
  addLegend(pal = world_pal, 
            values = countries_merged_wine$total, 
            position = "bottomright", 
            title = "Wines")
```

<br><img src="./image/us_map.png" alt="us_map" style="width:65%; border:2px solid"><br>

<br><img src="./image/world_map.png" alt="world_map" style="width:65%; border:2px solid"><br>

Static Map???
```{r static_map, eval=F, echo=T}
# world_static = map_data("world") %>%
#   left_join(wine_by_country, by = c("region" = "country"))
# 
# ggplot(data = world_static, 
#                mapping = aes(x = long, y = lat, group = group)) +
#   geom_polygon(aes(fill = avg_rating)) +
#   scale_fill_continuous(low = "rosybrown1", high = "darkred", 
#                         na.value = "snow2") +
#   coord_map(xlim = c(-180,180), ylim = c(-60, 80)) +
#   theme(
#     axis.title.x = element_blank(),
#     axis.text.x  = element_blank(),
#     axis.ticks.x = element_blank(),
#     axis.title.y = element_blank(),
#     axis.text.y  = element_blank(),
#     axis.ticks.y = element_blank(),
#     panel.background = element_rect(fill = "white"))
```

### summaries, and 

### exploratory statistical analyses
anova
2-sample ttest. 

Justify the steps you took, and show any major changes to your ideas.

#Additional analysis: 
If you undertake formal statistical analyses, describe these in detail

### linear model - multivariate

### linear model - name TBD

### linear model - cross validation

#Discussion: 
What were your findings? Are they what you expect? What insights into the data can you make?





