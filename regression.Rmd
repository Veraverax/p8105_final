---
title: ""
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(modelr)
library(mgcv)
```


```{r, message = FALSE, warning = FALSE}
red_df =  read_csv("./wine_data/tidy/wine_red.csv")
white_df = read_csv("./wine_data/tidy/wine_white.csv") 

red_df_reg =
  red_df %>%
  filter(year>=2000) %>%
  mutate(
         bold = str_detect(description, "bold"),
         tannin = str_detect(description, "tanni"),
         dry = str_detect(description, "dry"),
         acidity = str_detect(description, "acidi"),
         full_body = str_detect(tolower(description),
                                 paste(c("full body", "full in body"),collapse = '|')),
         price_cp1 = (price > 100) * (price - 100),
         price_cp2 = (price < 30) * (price - 30)
    )

white_df_reg = 
  white_df %>%
  filter(year>=2000) %>%
  mutate(price_cp1 = (price > 100) * (price - 100),
         price_cp2 = (price < 30) * (price - 30))
```


## Relationship between price and rating - the more expensive the better?

There has been a lot of ongoing discussion about the value behind the price tag of a bottle of wine. We usually believe that the more expensive wines are of better quality, but is that always true? Is the positive correlation can be further interpreted as a simple linear relationship?

The price of wine ranges from value purchase to luxury. The picture summary below shows a general price segmentation of wine. For more information, we highly recommend this [article](https://winefolly.com/lifestyle/reality-of-wine-prices-what-you-get-for-what-you-spend/) from Wine Folly provides more comprehensive discussion about price and quality. 

<h6 style="text-align: center;" markdown="1"><img src="image/wine_types.jpg" style="width:50%"></h6>

The wine price distribution from our dataset follows the trend of general pattern of the wine market.

```{r, message = FALSE, warning = FALSE}
library("patchwork")

a = red_df %>%
  ggplot2(aes(x=price))+ 
  geom_histogram()

```



```{r}
linear_mod_red = lm(points ~ price, data = red_df_reg)

pwl_mod_red = lm(points ~ price + price_cp1 + price_cp2,  data = red_df_reg)

smooth_mod_red = gam(points ~ s(price), data = red_df_reg)
```



## Fit models for white wine points

```{r}
fit_2 = lm(points ~ price + year, data = white_df_reg)

fit_2 %>% 
  broom::tidy()

linear_mod_white = lm(points ~ price, data = white_df_reg)

pwl_mod_white = lm(points ~ price + price_cp1 + price_cp2,  data = white_df_reg)

smooth_mod_white = gam(points ~ s(price), data = white_df_reg)
```
```{r}
red_df_reg %>%
  filter(price >= 100) %>%
  ggplot(aes (x = price, y = points, color = country))+ 
  geom_point()

white_df_reg %>%
  filter(price >= 100) %>%
  ggplot(aes (x = price, y = points, color = country))+ 
  geom_point()

white_df_reg %>%
  filter(points > 84) %>%
  ggplot(aes (x = country, y = price))+ 
  geom_boxplot()

```

Plot the 3 models with residuals

```{r}
library("patchwork")

a =
  red_df_reg %>% 
  gather_predictions(linear_mod_red, pwl_mod_red, smooth_mod_red) %>%
  mutate(model = fct_inorder(model)) %>%
  ggplot(aes(x = price, y = points)) + 
  geom_point(alpha = .05) +
  geom_line(aes(y = pred), color = "dark red") + 
  facet_grid(~model)
  
b = 
  white_df_reg %>% 
  gather_predictions(linear_mod_white, pwl_mod_white, smooth_mod_white) %>%
  mutate(model = fct_inorder(model)) %>%
  ggplot(aes(x = price, y = points)) + 
  geom_point(alpha = .05) +
  geom_line(aes(y = pred), color = "yellow") + 
  facet_grid(~model)


a

b
```

```{r}
# white_cv_df =
#   crossv_mc(white_df_reg, 100) %>% 
#   mutate(
#     train = map(train, as_tibble),
#     test = map(test, as_tibble))

# white_cv_df = 
#   white_cv_df %>% 
#   mutate(
#     linear_mod  = map(train, ~lm(points ~ price, data = .price)),
#     pwl_mod     = map(train, ~lm(armc ~ weight + weight_cp, data = .x)),
#     smooth_mod  = map(train, ~gam(armc ~ s(weight), data = as_tibble(.x)))) %>% 
#   mutate(
#     rmse_linear = map2_dbl(linear_mod, test, ~rmse(model = .x, data = .y)),
#     rmse_pwl    = map2_dbl(pwl_mod, test, ~rmse(model = .x, data = .y)),
#     rmse_smooth = map2_dbl(smooth_mod, test, ~rmse(model = .x, data = .y)))
# 
```


## Fit models for price


## Categorize old world and new world wine